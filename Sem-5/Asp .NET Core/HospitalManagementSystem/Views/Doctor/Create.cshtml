@model HospitalManagementSystem.Models.Doctor

@{
    bool isEdit = Model != null && Model.DoctorId > 0;
    string formAction = isEdit ? "Edit" : "Create";
    int UserId = CommonVariable.UserID() ?? 1;

    ViewData["Title"] = isEdit ? "Edit Doctor" : "Create Doctor";
}

<div class="pagetitle my-4">
    <h1 class="display-6">@(isEdit ? "Edit Doctor" : "Create Doctor")</h1>
    <p class="text-muted">
        @(isEdit ? "Update the doctor information below." : "Please fill in the details to create a new doctor.")
    </p>
</div>

<form method="post" asp-controller="Doctor" asp-action="@formAction" enctype="multipart/form-data">
    @if (isEdit)
    {
        <input type="hidden" asp-for="DoctorId" />
    }
    <input type="hidden" asp-for="UserID" value="@UserId" />

    <div class="row">
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center p-4">
                    <img id="photoPreview"
                         src="@(isEdit && !string.IsNullOrEmpty(Model.ProfilePhoto) ? Model.ProfilePhoto : "/images/default-profile.png")"
                         alt="Profile Photo"
                         class="rounded-circle img-fluid border border-3 border-primary mb-3"
                         style="width: 150px; height: 150px; object-fit: cover;">

                    <h5 class="my-3">Profile Photo</h5>
                    <p class="text-muted mb-4">Upload a clear photo of the doctor. (JPG, PNG)</p>

                    <div>
                        <label for="photoUpload" class="btn btn-primary">
                            <i class="bx bx-upload"></i> Upload New Photo
                        </label>
                        <input name="ProfilePhoto" id="photoUpload" type="file" accept="image/*" class="d-none" />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="row mb-3">
                        <label asp-for="Name" class="col-sm-3 col-form-label">Full Name <span class="text-danger">*</span></label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bx-user"></i></span>
                                <input asp-for="Name" class="form-control" placeholder="Enter full name" />
                            </div>
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>

                    <hr class="my-4" />
                    <h5 class="card-title mb-4">Professional Details</h5>

                    <div class="row mb-3">
                        <label asp-for="Qualification" class="col-sm-3 col-form-label">Qualification <span class="text-danger">*</span></label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bxs-graduation"></i></span>
                                <input asp-for="Qualification" class="form-control" placeholder="e.g. MBBS, MD" />
                            </div>
                            <span asp-validation-for="Qualification" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label asp-for="Specialization" class="col-sm-3 col-form-label">Specialization <span class="text-danger">*</span></label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bxs-star"></i></span>
                                <input asp-for="Specialization" class="form-control" placeholder="e.g. Cardiologist" />
                            </div>
                            <span asp-validation-for="Specialization" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <label class="col-sm-3 col-form-label">Department <span class="text-danger">*</span></label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bxs-building-house"></i></span>
                                <select name="SelectedDepartmentId" asp-items="@ViewBag.Departments" class="form-select">
                                    <option value="">-- Select a Department --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />
                    <h5 class="card-title mb-4">Contact Information</h5>

                    <div class="row mb-3">
                        <label asp-for="Email" class="col-sm-3 col-form-label">Email <span class="text-danger">*</span></label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bx-envelope"></i></span>
                                <input asp-for="Email" class="form-control" type="email" placeholder="example@domain.com" />
                            </div>
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label asp-for="Phone" class="col-sm-3 col-form-label">Phone <span class="text-danger">*</span></label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bx-phone"></i></span>
                                <input asp-for="Phone" class="form-control" placeholder="e.g. 9876543210" />
                            </div>
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>
                    </div>
                    <hr class="my-4" />
                    <div class="form-check form-switch mt-4">
                        <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" />
                        <label class="form-check-label" asp-for="IsActive">Set doctor as Active</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-8 offset-lg-4">
            <div class="card shadow-sm">
                <div class="card-body p-3 text-end">
                    <a asp-action="List" class="btn btn-outline-secondary">Back to List</a>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bx bx-save me-1"></i> @(isEdit ? "Save Changes" : "Create Doctor")
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const photoUpload = document.getElementById('photoUpload');
            const photoPreview = document.getElementById('photoPreview');

            // Live preview for selected profile photo
            photoUpload.addEventListener('change', function () {
                if (photoUpload.files && photoUpload.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        photoPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(photoUpload.files[0]);
                }
            });

            // Set the selected department in edit mode
            @if (isEdit && ViewBag.SelectedDepartmentId != null)
            {
                    <text>
                    document.querySelector('[name="SelectedDepartmentId"]').value = '@ViewBag.SelectedDepartmentId';
                    </text>
            }
        });
    </script>
}